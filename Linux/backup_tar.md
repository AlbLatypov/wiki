# Организация резервного копирования локальных файлов в домашней сети

## Цели, задачи, инструменты

Цель: копировать файлы из домашнего каталога /home/aflw

Инструменты:
 - целевой хост: 172.18.22.2 PIK-VIVO
 - бэкап хост: 172.18.22.3 PKL-AspireV13
 - dd
 - fstab
 - tar
 - dd
 - samba
 - nft

Краткое описание: 

На бэкап хосте: создать файл через dd размером 100Gb, создать файловую систему ext4, примаунтить, накинуть прав на каталог. Организовать монтирование при перезапуске бэкап хоста.

На целевом хосте: мапить расшаренный каталог бэкап машины и делать tar архивную копию (full+inc). Периодичность раз в неделю full, остальные инк.

Один раз в две недели проверять целостность архива путем восстановления. Делать копии на съемный носитель или в облако.

### Этапы реализации:

##### Создание файловой системы ext4 в отдельном файле на бэкап хосте

Бэкап хост. Определяем место для создания файла, необходимо 100Gb

`df -h`

Выбрал `mkdir /home/backup`, т.к. изначально при создании системы выделил 500 Gb для /home. Делаем с правами root. Owner и группа ansible, не хочу делать отдельного пользователя:
`chown ansible:ansible /home/backup`
`chmod 774 /home/backup` - user:group rwx, остальные пусть r

##### Создание файла, с которым можно работать также как с диском через dd, mkfs на бэкап хосте

Создаем файл размером 100Gb, наполненный нулями

`dd if=/dev/zero of=/home/backup/file_100 bs=1G count=100`

__if__ - input file, то , чем наполняем файл, в данном случае zero
__of__ - output file, куда будем писать
__bs__ - block size
__count__ - количество блоков

Общий размер файла получается путем умножения bs*count. Т.к. архивы будут большими и их будет не так много, bs ставлю размером 1Gb.

Время создания файла примерно 20 минут.

>root@PKL-AspireV13:/home# dd if=/dev/zero of=/home/backup/file_100 bs=1G >count=100
>100+0 records in
>100+0 records out
>107374182400 bytes (107 GB, 100 GiB) copied, __1092,72 s__, 98,3 MB/s

Можно проверить утилитой `hexer`, увидим файл наполненный нулями. Но лучше этого не делать, если файл 100GB, сожрет всю память и linux убьет этот процесс.

Создание файловой системы внутри файла __/home/backup/file_100__:

`mkfs.ext2 /home/backup/file_100`

Создаю не журналируемую файловую систему ext2 (ext2 — та же ext3, только без поддержки журналирования, за счет чего работает быстрее.). Почитать можно [здесь](https://habr.com/ru/articles/54043/)

##### Монтирование при помощи systemd на бэкап хосте

Создаем каталог куда будем монтировать файловую систему.

`mkdir /mnt/vivobackup`

Дополнительно можно почитать [здесь](https://interface31.ru/tech_it/2022/09/montirovanie-faylovyh-sistem-pri-pomoshhi-systemd.html)

Создаем __юнит монтирования__ - это специальные файлы с описаниями служб, которые используются systemd для их активации. 

Существуют различные типы юнитов, для монтирования файловых систем предназначены юниты типа mount, их следует располагать в каталоге
`/etc/systemd/system`.
Существуют специальные правила именования таких файлов: они должны содержать путь к точке монтирования в которой все слеши, кроме начального, заменяются на дефис. Например, если точка монтирования у нас /home/user/video, то имя файла юнита должно быть `home-user-video.mount.`

`touch /etc/systemd/system/mnt-vivobackup.mount`

c содержанием

>[Unit]
>Description=Backup Vivo
>
>[Mount]
>What=/home/backup/file100
>Where=/mnt/vivobackup
>
>[Install]
>WantedBy=multi-user.target

Далее,

перечитаем конфигурацию systemd (это нужно делать после добавления каждого нового файла юнита):\
`systemctl daemon-reload`

И попробуем смонтировать наше устройство:\
`systemctl start mnt-vivobackup.mount`

Перезагружаемся, проверяем\
`df -hT`
>/dev/loop1     ext2    99G   24K   94G   1% /mnt/vivobackup

Убедившись, что все работает нормально, добавим точку монтирования в автозагрузку:\
`systemctl enable mnt-vivobackup.mount`
<br>

##### Монтируем к целевому хосту при помощи SSHFS

Можно примонтировать файловую систему на удаленном хосте через SSH к целевому хосту и уже писать в этот каталог. [Youtube | Описание работы в SSHFS](https://youtu.be/-0jyrvMl0Ic)

Можно поиграть с правами и подключаться от имени ansible. Предварительно накинуть на каталог бэкап хоста ansible:ansible `/mnt/vivobackup`

`sshfs -p 212 ansible@172.18.22.3:/mnt/vivobackup /mnt/backup_share`

Размонтировать можно так:

`umount share` 
или
`fusermount -u /home/aflw/share`

##### Запускаем резервное копирование

`tar --verbose --create --file=/mnt/backup_share/full_home.tar -X /mnt/exclude_file --listed-incremental=/mnt/backup_share/full_home.snar /home/aflw/ > /mnt/backup_share/full_home.log`

В скрипте отразить сначала подключение по sshfs и последующее отключение.
